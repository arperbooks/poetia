<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Poetia — Librería cuántica</title>

  <style>
    /* -------------------------
       Estilos (paleta A: blanco + dorado + gris suave)
       ------------------------- */
    :root{
      --bg:#FAFAFB;
      --card:#FFFFFF;
      --accent:#C79A2B; /* dorado suave */
      --muted:#6B7280;
      --text:#0F172A;
      --glass: rgba(16,24,40,0.04);
      --radius:12px;
      --maxw:1100px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue";background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased;}
    .wrap{max-width:var(--maxw);margin:28px auto;padding:16px;}
    header{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:62px;height:62px;border-radius:12px;background:linear-gradient(135deg,#fff,#f7f1e0);display:flex;align-items:center;justify-content:center;font-weight:800;color:var(--accent);font-size:22px;box-shadow:0 6px 18px rgba(16,24,40,0.05)}
    nav a{color:var(--muted);text-decoration:none;margin-left:14px;font-weight:600}
    .hero{background:linear-gradient(90deg,#ffffff,#fbf9f4);padding:28px;border-radius:18px;margin-top:18px;display:flex;gap:18px;align-items:center;box-shadow:0 8px 30px rgba(16,24,40,0.04)}
    .hero .left{flex:1}
    .hero h1{margin:0;font-size:30px;letter-spacing:0.2px}
    .hero p{color:var(--muted);margin-top:8px}
    .cta{margin-top:14px;display:flex;gap:10px;flex-wrap:wrap}
    .btn{background:var(--accent);color:#fff;padding:10px 14px;border-radius:10px;border:0;cursor:pointer;font-weight:700}
    .btn.ghost{background:transparent;border:1px solid rgba(16,24,40,0.06);color:var(--text)}
    .grid{display:grid;grid-template-columns:1fr 340px;gap:22px;margin-top:20px}
    .panel{background:var(--card);padding:16px;border-radius:12px;box-shadow:0 6px 18px rgba(16,24,40,0.03)}
    .cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:14px}
    .book{background:var(--glass);padding:12px;border-radius:10px;overflow:hidden;display:flex;flex-direction:column;gap:8px}
    .cover{height:160px;border-radius:8px;background:#f3f4f6;display:flex;align-items:center;justify-content:center;color:var(--muted);overflow:hidden}
    .cover img{width:100%;height:100%;object-fit:cover}
    .title{font-weight:700;font-size:15px}
    .desc{font-size:13px;color:var(--muted);min-height:40px}
    .row{display:flex;justify-content:space-between;align-items:center;margin-top:8px;gap:8px}
    .smallbtn{padding:8px 10px;border-radius:10px;background:transparent;border:1px solid rgba(16,24,40,0.06);color:var(--text);cursor:pointer;font-weight:600}
    aside .cardmini{padding:12px;margin-bottom:12px;border-radius:12px;background:linear-gradient(180deg,#fff,#fbfbfb)}
    .category-list{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
    .chip{padding:8px 10px;border-radius:999px;background:#fff;border:1px solid rgba(16,24,40,0.04);color:var(--muted);cursor:pointer;font-size:13px}
    .chip.active{background:var(--accent);color:white;border:none}
    .carousel{display:flex;gap:12px;overflow:auto;padding-bottom:8px}
    footer{color:var(--muted);text-align:center;margin-top:26px;padding:20px}
    input,textarea{font-family:inherit}
    @media (max-width:900px){.grid{grid-template-columns:1fr}.hero{flex-direction:column;align-items:flex-start}.cover{height:180px}}
  </style>
</head>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>
<script>
  const SUPABASE_URL = "TU_SUPABASE_URL";
  const SUPABASE_ANON_KEY = "TU_ANON_KEY";
  const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  async function cargarLibros() {
    const { data: books, error } = await supabase.from('books').select('*').order('created_at', { ascending:false });
    if(error) { console.error(error); return; }
    const carousel = document.getElementById('carousel');
    if(!carousel) return;
    books.forEach(b => {
      const card = document.createElement('div');
      card.innerHTML = `
        <img src="${b.cover_url}" style="width:100%;height:auto" />
        <h3>${b.title}</h3>
      `;
      carousel.appendChild(card);
    });
  }
  window.addEventListener('load', cargarLibros);
</script>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo">P</div>
        <div>
          <div style="font-weight:800">Poetia</div>
          <div style="font-size:12px;color:var(--muted)">Poesía cuántica — libros y audiolibros</div>
        </div>
      </div>

      <nav>
        <a href="#libros">Libros</a>
        <a href="#poemas">Poemas</a>
        <a href="#audiolibros">Audiolibros</a>
        <a href="#sorteos">Sorteos</a>
        <a href="#suscribir" class="smallbtn">Suscribirse</a>
      </nav>
    </header>

    <section class="hero panel">
      <div class="left">
        <h1>Poetia — Biblioteca cuántica</h1>
        <p>Accede a libros, audiolibros y poemas seleccionados. Suscríbete para recibir el pack completo y participar en sorteos exclusivos.</p>
        <div class="cta">
          <button class="btn" id="btnBuy">Comprar acceso (Pack)</button>
          <button class="btn ghost" id="btnExplore">Explorar gratis</button>
        </div>
      </div>
      <div class="right" style="width:320px">
        <div style="background:linear-gradient(180deg,#fff,#faf7f0);padding:12px;border-radius:8px">
          <div style="font-size:13px;color:var(--muted)">Destacado</div>
          <div style="font-weight:700;margin-top:8px">Colección: Amaneceres y Selva</div>
          <div style="margin-top:10px;color:var(--muted);font-size:13px">Poemas inéditos, audiolibros y libros del autor.</div>
        </div>
      </div>
    </section>

    <div class="grid">
      <main>
        <!-- CARRUSEL GENERAL -->
        <div class="panel" style="margin-top:8px">
          <h3>Destacados</h3>
          <div id="carousel" class="carousel" aria-hidden="false"></div>
        </div> 
        <!-- lugar del carrusel en tu HTML -->
<div id="carousel" class="carrusel-contenedor" style="padding:18px"></div>
<input id="admTitle" placeholder="Título">
<input id="admCategory" placeholder="Categoría" value="Mis Libros">
<textarea id="admDesc" placeholder="Descripción"></textarea>
<input type="file" id="admCover" accept="image/*">
<input type="file" id="admFile" accept=".pdf,audio/*,video/*">
<button id="admUploadBtn">Subir libro</button>
<div id="admMsg"></div>


        <!-- SECCION LIBROS -->
        <div id="libros" class="panel" style="margin-top:18px">
          <h3>Libros</h3>
          <div style="margin-top:8px;display:flex;align-items:center;gap:8px">
            <div class="category-list" id="categories"></div>
          </div>
          <div class="cards" id="booksGrid" style="margin-top:14px"></div>
        <!-- POEMAS -->
        <div id="poemas" class="panel" style="margin-top:18px">
          <h3>Poemas recientes</h3>
          <div id="poems" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-top:12px"></div>
        </div>

        <!-- AUDIO -->
        <div id="audiolibros" class="panel" style="margin-top:18px">
          <h3>Audiolibros</h3>
          <div id="audioGrid" class="cards" style="margin-top:12px"></div>
        </div>

        <!-- SORTEOS -->
        <div id="sorteos" class="panel" style="margin-top:18px">
          <h3>Sorteos</h3>
          <p style="color:var(--muted)">Suscríbete y participa en sorteos mensuales (ej: iPhone). Revisa reglas en la página de sorteos.</p>
          <div style="margin-top:12px">
            <button class="btn" id="btnDraw">Realizar sorteo (admin)</button>
          </div>
        </div>
      </main>

      <aside>
        <div class="cardmini panel">
          <h4>Suscríbete</h4>
          <p style="color:var(--muted);font-size:13px">Recibe poemas exclusivos y participa en sorteos.</p>
          <div style="margin-top:10px">
            <input id="subEmail" placeholder="tu@correo.com" style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(16,24,40,0.04);background:#fff;color:var(--text)">
            <button class="btn" style="width:100%;margin-top:10px" id="subBtn">Suscribirme</button>
            <div id="subMsg" style="margin-top:8px;color:var(--muted);font-size:13px"></div>
          </div>
        </div>

        <div class="cardmini panel">
          <h4>Mis libros</h4>
          <p style="color:var(--muted);font-size:13px;margin-bottom:8px">Admin: sube desde aquí</p>
          <div id="miniList" style="display:flex;flex-direction:column;gap:8px"></div>
        </div>

        <div class="cardmini panel">
          <h4>Estadísticas</h4>
          <div style="font-size:18px;font-weight:700">Suscriptores: <span id="countSubs">0</span></div>
          <div style="color:var(--muted);font-size:13px;margin-top:8px">Participantes: <span id="countEntries">0</span></div>
        </div>

        <!-- Panel admin simple (temporal) -->
        <div class="cardmini panel" style="margin-top:12px">
          <h4>Admin — Subir libro</h4>
          <input id="admTitle" placeholder="Título" style="width:100%;padding:8px;border-radius:8px;border:1px solid rgba(16,24,40,0.04);margin-bottom:8px">
          <input id="admCategory" placeholder="Categoría" style="width:100%;padding:8px;border-radius:8px;border:1px solid rgba(16,24,40,0.04);margin-bottom:8px" value="Mis Libros">
          <textarea id="admDesc" placeholder="Descripción" style="width:100%;padding:8px;border-radius:8px;border:1px solid rgba(16,24,40,0.04);margin-bottom:8px"></textarea>
          <label style="font-size:13px;color:var(--muted)">Portada (jpg/png)</label>
          <input type="file" id="admCover" accept="image/*" style="margin-bottom:8px">
          <label style="font-size:13px;color:var(--muted)">Archivo (pdf/mp3)</label>
          <input type="file" id="admFile" accept=".pdf,audio/*,video/*" style="margin-bottom:8px">
          <button class="btn" id="admUploadBtn" style="width:100%;">Subir libro</button>
          <div id="admMsg" style="margin-top:8px;color:var(--muted);font-size:13px"></div>
        </div>

      </aside>
    </div>

    <footer>
      © <span id="year"></span> Poetia — Percy “Perseo” · Harper Books
    </footer>
  </div>

  <!-- Supabase UMD -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>

  <script>
  // ============================
  // REEMPLAZA ESTOS VALORES
  // ============================
  const SUPABASE_URL = "YOUR_SUPABASE_URL";           // Ej: https://cxtafkdtibzbkqeuvzoq.supabase.co
  const SUPABASE_ANON_KEY = "YOUR_SUPABASE_ANON_KEY"; // eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN4dGFma2R0aWJ6YmtxZXV2em9xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ0MjQ5MDMsImV4cCI6MjA4MDAwMDkwM30.wr1yJtDT0pfAWwyDlgxHqBeDuEXIXCvvB3J90PfpU3M

  // Inicializa Supabase
  const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // Estado
  const state = { books: [], subscribers: 0, entries: 0 };

  document.getElementById('year').innerText = new Date().getFullYear();

  // --- Funciones principales ---
  async function loadBooks(){
    const { data, error } = await supabase.from('books').select('*').order('created_at', { ascending:false });
    if(error){ console.error('Error al leer books:', error); return; }
    state.books = data || [];
    renderCategories();
    renderBooks();
    renderCarousel();
    renderMini();
  }

  function renderCategories(){
    const set = new Set(state.books.map(b => b.category || 'General'));
    const container = document.getElementById('categories');
    container.innerHTML = '';
    const all = document.createElement('div'); all.className='chip active'; all.innerText='Todos';
    all.onclick = ()=>{ document.querySelectorAll('.chip').forEach(c=>c.classList.remove('active')); all.classList.add('active'); renderBooks(); };
    container.appendChild(all);
    set.forEach(cat=>{
      const d = document.createElement('div'); d.className='chip'; d.innerText = cat;
      d.onclick = ()=> { document.querySelectorAll('.chip').forEach(c=>c.classList.remove('active')); d.classList.add('active'); renderBooks(cat); }
      container.appendChild(d);
    });
  }

  function renderBooks(filter){
    const grid = document.getElementById('booksGrid');
    grid.innerHTML = '';
    const books = state.books.filter(b => !filter || (b.category || 'General') === filter);
    if(books.length === 0){ grid.innerHTML = '<div style="color:var(--muted);padding:18px">No hay libros en esta categoría.</div>'; return; }
    books.forEach(b=>{
      const el = document.createElement('article'); el.className='book';
      const cover = document.createElement('div'); cover.className='cover';
      if(b.cover_url){
        const img = document.createElement('img'); img.src = b.cover_url; cover.innerHTML=''; cover.appendChild(img);
      } else cover.innerText = 'Portada';
      el.appendChild(cover);
      const t = document.createElement('div'); t.className='title'; t.innerText = b.title || 'Sin título';
      el.appendChild(t);
      const d = document.createElement('div'); d.className='desc'; d.innerText = b.description || '';
      el.appendChild(d);
      const row = document.createElement('div'); row.className='row';
      const btnView = document.createElement('button'); btnView.className='smallbtn'; btnView.innerText='Ver';
      btnView.onclick = ()=> openBook(b);
      const btnBuy = document.createElement('button'); btnBuy.className='smallbtn'; btnBuy.innerText = (b.price && b.price>0) ? `S/${b.price}` : 'Gratis';
      btnBuy.onclick = ()=> buyBook(b);
      row.appendChild(btnView); row.appendChild(btnBuy);
      el.appendChild(row);
      grid.appendChild(el);
    })
  }

  function renderCarousel(){
    const car = document.getElementById('carousel'); car.innerHTML='';
    const items = state.books.slice(0,12);
    items.forEach(b=>{
      const c = document.createElement('div'); c.style.minWidth='260px';
      c.innerHTML = `
        <div style="background:var(--card);padding:12px;border-radius:12px;box-shadow:0 8px 20px rgba(16,24,40,0.03)">
          <div style="height:140px;border-radius:8px;overflow:hidden;background:#fff;margin-bottom:10px">
            ${b.cover_url? `<img src="${b.cover_url}" style="width:100%;height:100%;object-fit:cover">` : 'Portada'}
          </div>
          <div style="font-weight:700">${b.title||''}</div>
          <div style="color:var(--muted);font-size:13px">${(b.description||'').slice(0,80)}</div>
        </div>
      `;
      car.appendChild(c);
    });
    // auto-scroll suave
    let scrollStep = 0;
    let auto = setInterval(()=>{ car.scrollBy({left:2, behavior:'auto'}); scrollStep++; if(scrollStep>350){ car.scrollTo({left:0, behavior:'smooth'}); scrollStep=0 } }, 40);
    car.addEventListener('mouseover', ()=> clearInterval(auto));
    car.addEventListener('mouseout', ()=> {
      auto = setInterval(()=>{ car.scrollBy({left:2, behavior:'auto'}); }, 40);
    });
  }

  // Mini lista lateral
  function renderMini(){
    const mini = document.getElementById('miniList'); mini.innerHTML='';
    state.books.slice(0,5).forEach(b=>{
      const d = document.createElement('div'); d.style.display='flex'; d.style.justifyContent='space-between';
      d.innerHTML = `<div style="font-size:13px">${b.title||'Sin título'}</div><div style="color:var(--muted)">${(b.category||'')}</div>`;
      mini.appendChild(d);
    })
  }

  // Abrir libro (usa file_url directo)
  function openBook(b){
    if(!b.file_url){ alert('No hay archivo disponible'); return; }
    window.open(b.file_url, '_blank');
  }

  // Comprar libro (redirige a endpoint de checkout)
  function buyBook(b){
    // si aún no tienes endpoint, muestra mensaje
    window.location.href = `/api/create-checkout-session?book_id=${encodeURIComponent(b.id)}`;
  }

  // SUSCRIPCION
  document.getElementById('subBtn').onclick = async ()=>{
    const email = document.getElementById('subEmail').value.trim();
    const msg = document.getElementById('subMsg');
    msg.innerText = '';
    if(!email) return msg.innerText = 'Ingresa un email válido';
    // guardar en subscribers
    const { data, error } = await supabase.from('subscribers').upsert({ email }).select();
    if(error){ msg.innerText = 'Error al suscribirse'; console.error(error); return; }
    msg.innerText = 'Gracias. Revisa tu correo para confirmar.';
    // añadir entrada al sorteo
    await supabase.from('entries').insert([{ email, source:'subscribe' }]).catch(()=>{});
    countStats();
  };

  // CONTADORES
  async function countStats(){
    const { count: subs } = await supabase.from('subscribers').select('*', { count:'exact' });
    const { count: entries } = await supabase.from('entries').select('*', { count:'exact' });
    document.getElementById('countSubs').innerText = subs || 0;
    document.getElementById('countEntries').innerText = entries || 0;
  }

  // ADMIN: subir cover + archivo al bucket 'poetia-files' y crear registro en tabla books
  document.getElementById('admUploadBtn').onclick = async ()=>{
    const title = document.getElementById('admTitle').value.trim();
    const category = document.getElementById('admCategory').value.trim() || 'Mis Libros';
    const desc = document.getElementById('admDesc').value.trim();
    const coverInput = document.getElementById('admCover');
    const fileInput = document.getElementById('admFile');
    const admMsg = document.getElementById('admMsg');
    admMsg.innerText = '';
    if(!title) return admMsg.innerText = 'Agrega título';
    try{
      let coverPath = null;
      let filePath = null;
      // subir portada
      if(coverInput.files && coverInput.files[0]){
        const file = coverInput.files[0];
        const key = `covers/${Date.now()}_${file.name}`;
        const { error: e1 } = await supabase.storage.from('poetia-files').upload(key, file, { upsert: false });
        if(e1) throw e1;
        // obtener url pública (si bucket es público)
        coverPath = `${SUPABASE_URL.replace(/\/$/,'')}/storage/v1/object/public/poetia-files/${encodeURIComponent(key)}`;
      }
      // subir archivo (pdf/mp3)
      if(fileInput.files && fileInput.files[0]){
        const f = fileInput.files[0];
        const key2 = `files/${Date.now()}_${f.name}`;
        const { error: e2 } = await supabase.storage.from('poetia-files').upload(key2, f, { upsert: false });
        if(e2) throw e2;
        filePath = `${SUPABASE_URL.replace(/\/$/,'')}/storage/v1/object/public/poetia-files/${encodeURIComponent(key2)}`;
      }
      // crear slug simple
      const slug = title.toLowerCase().replace(/\s+/g,'-').replace(/[^a-z0-9\-]/g,'');
      // insertar en tabla books
      const { data, error } = await supabase.from('books').insert([{ title, slug, description: desc, cover_url: coverPath, file_url: filePath, category }]);
      if(error) throw error;
      admMsg.innerText = 'Libro subido correctamente';
      // limpiar formulario
      document.getElementById('admTitle').value=''; document.getElementById('admDesc').value=''; document.getElementById('admCover').value=''; document.getElementById('admFile').value='';
      // recargar
      await loadBooks(); countStats();
    }catch(err){
      console.error(err);
      admMsg.innerText = 'Error al subir: ' + (err.message || err);
    }
  };

  // SORTEO (llama endpoint serverless /api/draw)
  document.getElementById('btnDraw').onclick = async ()=>{
    if(!confirm('¿Realizar sorteo ahora? (solo admin)')) return;
    const res = await fetch('/api/draw', { method:'POST', headers: { 'x-admin-secret': 'PUT_ADMIN_SECRET_HERE' }});
    if(!res.ok){ alert('Error al llamar al endpoint'); return; }
    const json = await res.json();
    alert('Ganador: ' + (json.winner?.email || JSON.stringify(json.winner)));
  };

  // BOTONES
  document.getElementById('btnExplore').onclick = ()=> window.location.href = '#libros';
  document.getElementById('btnBuy').onclick = ()=> window.location.href = '/api/create-checkout-session';

  // Ejecutar carga inicial
  (async function init(){
    await loadBooks();
    await countStats();
    // poemas de ejemplo si no hay tabla poems
    const poemsContainer = document.getElementById('poems');
    if(poemsContainer.innerHTML.trim()===''){
      const examples = [
        { title:'Amanecer en Rioja', text:'Despierto y el cielo me mira...' },
        { title:'Piel de Lluvia', text:'Tu voz cae suave...' },
        { title:'Río y Verso', text:'La selva respira viejas canciones...' }
      ];
      examples.forEach(p=>{
        const d = document.createElement('div'); d.className='book'; d.style.background:'#fff';
        d.innerHTML = `<div style="font-weight:700">${p.title}</div><div style="color:var(--muted);margin-top:6px">${p.text}</div>`;
        poemsContainer.appendChild(d);
      });
    }
  })();
  </script>
</body>
</html>
<!-- === Supabase CDN === -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>

<script>
/* ============================
  CONFIG — pega tus claves aquí
  ============================ */
const SUPABASE_URL = "YOUR_SUPABASE_URL";           // ej: https://abcd1234.supabase.co
const SUPABASE_ANON_KEY = "YOUR_SUPABASE_ANON_KEY";

// inicializa supabase
const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ============================
  FUNCIONES: cargar libros y renderizar carrusel
  ============================ */

async function loadBooksAndRender() {
  // 1) traer libros de la tabla "books"
  const { data: books, error } = await supabase
    .from('books')
    .select('*')
    .order('created_at', { ascending: false });

  if (error) {
    console.error('Error cargando books:', error);
    return;
  }

  // 2) pintar carrusel principal (elemento con id="carousel" en tu HTML)
  const carousel = document.getElementById('carousel');
  if (!carousel) return console.warn('No se encontró #carousel en la página.');

  carousel.innerHTML = ''; // limpiar

  books.forEach(book => {
    const card = document.createElement('div');
    card.className = 'item-carrusel'; // usa el estilo que tengas

    const imgHtml = book.cover_url
      ? `<img src="${book.cover_url}" alt="${escapeHtml(book.title||'Portada')}">`
      : `<div style="height:270px;display:flex;align-items:center;justify-content:center;color:#6c5f5b">Sin portada</div>`;

    card.innerHTML = `
      ${imgHtml}
      <div style="margin-top:10px;font-weight:700">${escapeHtml(book.title||'Sin título')}</div>
      <div style="color:#6c5f5b;font-size:13px;margin:6px 0">${escapeHtml((book.description||'').slice(0,100))}</div>
      <div style="display:flex;gap:8px">
        <button class="boton" onclick="openBook('${encodeURIComponent(book.file_url||'')}')">Leer</button>
        <button class="boton" onclick="openDetails('${book.id}')">Detalles</button>
      </div>
    `;
    carousel.appendChild(card);
  });

  // iniciar auto-scroll (suave)
  initAutoScroll(carousel);
}

/* helpers */
function escapeHtml(str){ return (str+'').replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])); }

function openBook(fileUrlEncoded){
  const url = decodeURIComponent(fileUrlEncoded || '');
  if(!url) return alert('Archivo no disponible');
  window.open(url, '_blank');
}

function openDetails(bookId){
  // aquí puedes redirigir a una página /book.html?id=... o abrir modal
  alert('Abrir detalles del libro: ' + bookId);
}

/* auto-scroll para el carrusel */
let _autoInterval = null;
function initAutoScroll(container){
  if(!_autoInterval) {
    _autoInterval = setInterval(()=> {
      try{
        container.scrollBy({ left: 2, behavior: 'smooth' });
        // si llegó al final, regresar al inicio
        if(container.scrollLeft + container.clientWidth >= container.scrollWidth - 10){
          container.scrollTo({ left: 0, behavior: 'smooth' });
        }
      }catch(e){ /* ignore */ }
    }, 40);
    container.addEventListener('mouseover', ()=> clearInterval(_autoInterval));
    container.addEventListener('mouseout', ()=> {
      if(_autoInterval) clearInterval(_autoInterval);
      _autoInterval = setInterval(()=> {
        try{ container.scrollBy({ left: 2, behavior: 'smooth' }); }catch(e){}
      }, 40);
    });
  }
}

/* ============================
  PANEL: subir portada + archivo desde la página (admin simple)
  Requiere que en tu HTML haya:
  - <input type="file" id="admCover">  para portada
  - <input type="file" id="admFile">   para pdf/mp3
  - <input id="admTitle">, #admCategory, #admDesc, #admUploadBtn, #admMsg
  ============================ */

document.addEventListener('click', (e)=>{
  if(e.target && e.target.id === 'admUploadBtn'){
    uploadAdminBook();
  }
});

async function uploadAdminBook(){
  const title = (document.getElementById('admTitle')||{value:''}).value.trim();
  const category = (document.getElementById('admCategory')||{value:'Mis Libros'}).value.trim() || 'Mis Libros';
  const desc = (document.getElementById('admDesc')||{value:''}).value.trim();
  const coverInput = document.getElementById('admCover');
  const fileInput = document.getElementById('admFile');
  const admMsg = document.getElementById('admMsg');

  if(!title){ if(admMsg) admMsg.innerText = 'Agrega un título'; return; }

  try{
    let coverUrl = null;
    let fileUrl = null;

    // subir portada si hay
    if(coverInput && coverInput.files && coverInput.files[0]){
      const file = coverInput.files[0];
      const key = `covers/${Date.now()}_${file.name}`;
      const { data, error } = await supabase.storage.from('poetia-files').upload(key, file, { upsert: false });
      if(error) throw error;
      // URL pública
      coverUrl = `${SUPABASE_URL.replace(/\/$/,'')}/storage/v1/object/public/poetia-files/${encodeURIComponent(key)}`;
    }

    // subir archivo (pdf/mp3)
    if(fileInput && fileInput.files && fileInput.files[0]){
      const file = fileInput.files[0];
      const key2 = `files/${Date.now()}_${file.name}`;
      const { data, error } = await supabase.storage.from('poetia-files').upload(key2, file, { upsert: false });
      if(error) throw error;
      fileUrl = `${SUPABASE_URL.replace(/\/$/,'')}/storage/v1/object/public/poetia-files/${encodeURIComponent(key2)}`;
    }

    // insertar fila en tabla books
    const slug = title.toLowerCase().replace(/\s+/g,'-').replace(/[^a-z0-9\-]/g,'');
    const { data: insertData, error: insertError } = await supabase.from('books').insert([{
      title, slug, description: desc, cover_url: coverUrl, file_url: fileUrl, category
    }]);
    if(insertError) throw insertError;

    if(admMsg) admMsg.innerText = 'Libro subido correctamente';
    // limpiar inputs
    if(document.getElementById('admTitle')) document.getElementById('admTitle').value = '';
    if(document.getElementById('admDesc')) document.getElementById('admDesc').value = '';
    if(coverInput) coverInput.value = '';
    if(fileInput) fileInput.value = '';

    // recargar libros
    await loadBooksAndRender();
  }catch(err){
    console.error('Error subiendo libro:', err);
    if(admMsg) admMsg.innerText = 'Error: ' + (err.message||err);
  }
}

/* CARGA INICIAL */
window.addEventListener('load', ()=> {
  loadBooksAndRender();
});
</script>
